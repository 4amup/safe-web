{% extends "layout.njk" %}
{# 首页自定义样式文件 #}
{% block stylesheets %}
<link rel="stylesheet" href="css/index.css">
{% endblock %}

{% block content %}
<h1>{{ title }}</h1>
<div class="container">
  <div id="map" style="min-width:600px; min-height:600px"></div>
  <form action="/upload" method="post" enctype="multipart/form-data" id="form">
    <div id="upfile" class="upfile upfile-advanced">
      <label id="demo-preview" for="demo-file">照片上传：</label>
      <input type="file" id="demo-file" accept="image/*">
    </div>
    <div>
      <label id="location">定位点：</label>
      <select id="department">
        {# 第一级可以后端直接渲染好，第二级将数据传进html，由页面js实时更改联动，可参考百度前端学院任务 #}
        <option value ="vessel-factory">重容分厂</option>
        <option value ="tube-factory">管子分厂</option>
      </select>
      <select id="region">
        <option value ="region-1">一跨</option>
        <option value ="region-2">二跨</option>
      </select>
    </div>
    <p>
      <label for="description">问题描述：</label>
      <input type="text" name="description" id="troubleDescription">
    </p>
    <p>
      <input type="submit" value="提交">
    </p>
  </form>
</div>
<script src="vendors/exif.js"></script>
<script src="js/index.js"></script>
<script>
{# 此脚本程序用于实时在前端页面显示图片预览，前端位置信息和select双向绑定 #}
(function(){
  var upfileBox = $('#upfile');
  var fileInput = $('#demo-file');
  var fileLabel = $('#demo-preview');
  var demoLog = $('#demo-log');
  var demoVal = $('#demo-val');

  if (typeof window.FileReader === 'function' || typeof window.FileReader === 'object') {
    upfileBox.addClass('upfile-advanced');

    var oFile = new FileReader();
    var passFileType = /^(?:image\/bmp|image\/gif|image\/jpeg|image\/png)$/i;

    oFile.onloadend = function(oFREvent){
      fileLabel.attr('class', '');

      var state = oFREvent.currentTarget.readyState;
      if (state === 2) {
        fileLabel.addClass('set').css('backgroundImage', 'url(' + oFREvent.target.result + ')');
      } else {
        fileLabel.addClass('error');
      };
    };

    fileInput.on('change', function(e){
      if (!e.target || !e.target.files.length || !e.target.files[0]) {return};

      var _file = e.target.files[0];

      if (!passFileType.test(_file.type)) {return};

      oFile.readAsDataURL(_file);

      EXIF.getData(_file, function(){
        var _dataTxt = EXIF.pretty(this);
        var _dataJson = JSON.stringify(EXIF.getAllTags(this));

        demoLog.html(_dataJson);
        demoVal.val(_dataTxt);

        var _rotate = 0;
        var _orientation = EXIF.getTag(this, 'Orientation');

        if (_orientation == 3) {
          _rotate = 180;
        } else if (_orientation == 6) {
          _rotate = 90;
        } else if (_orientation == 8) {
          _rotate = 270;
        };

        fileLabel.addClass('rotate-' + _rotate);
      });
    });
  };
})();
</script>
{% endblock %}